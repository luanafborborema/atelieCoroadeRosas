<!-- START OF FILE admin.html -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Ateli√™ Coroa de Rosas</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-container{max-width:800px;margin:50px auto;padding:30px;background:#fff;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.1)}.admin-title{text-align:center;color:#d7547e;margin-bottom:30px;font-size:2rem;border-bottom:2px solid #f8f0f4;padding-bottom:15px}.form-group{margin-bottom:20px}.form-group label{display:block;margin-bottom:8px;font-weight:700;color:#333}.form-group input,.form-group select,.form-group textarea{width:100%;padding:12px;border:2px solid #f0f0f0;border-radius:8px;font-size:1rem;transition:border-color .3s ease}.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:#d7547e}.btn-admin{background:linear-gradient(135deg,#d7547e 0,#b33c62 100%);color:#fff;padding:15px 30px;border:none;border-radius:8px;font-size:1.1rem;font-weight:700;cursor:pointer;width:100%;transition:transform .3s ease}.btn-admin:hover{transform:translateY(-2px)}.error-message,.success-message{text-align:center;margin-top:15px;display:none;padding:10px;border-radius:8px}.error-message{color:#e74c3c;background-color:#fdd}.success-message{color:#27ae60;background-color:#e0f8e0}.login-form{display:block}.admin-panel{display:none}#gerenciarProdutos{margin-top:50px}#listaProdutosAdmin{list-style:none;padding:0}.produto-item-admin{display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid #eee}.produto-item-admin:last-child{border-bottom:none}.produto-item-admin span{font-weight:700}
        .actions-container { display: flex; align-items: center; gap: 15px; } .views-count { color:#666; font-size: 0.9rem; font-weight: bold; }
        .btn-action{padding:5px 10px;border:none;border-radius:5px;cursor:pointer;color:#fff;font-size:0.9rem}.btn-edit{background-color:#3498db;margin-right:5px}.btn-delete{background-color:#e74c3c}#cancelarEdicaoBtn{width:auto;background:#7f8c8d;margin-top:10px;display:none}
        #imagensURLs { min-height: 100px; }
    </style>
</head>
<body>
<header><nav class="navbar"><div class="logo"><a href="index.html"><img src="imagens/logo.coroaderosas.png" alt="Logo"></a></div></nav></header>
<div class="admin-container">
    <div class="login-form" id="loginForm"><h2 class="admin-title">Acesso Administrativo</h2><div class="form-group"><label for="senha">Senha:</label><input type="password" id="senha" placeholder="Digite a senha" onkeydown="if(event.key==='Enter') verificarSenha()"></div><button class="btn-admin" onclick="verificarSenha()">Acessar</button><div class="error-message" id="loginError"></div></div>
    <div class="admin-panel" id="adminPanel"><div id="formContainer"><h2 class="admin-title" id="formTitle">Cadastrar Novo Produto</h2><input type="hidden" id="produtoId">
        <div class="form-group"><label for="categoria">Categoria:</label><select id="categoria"><option value="tercos">Ter√ßos</option><option value="chaveiros">Chaveiros</option><option value="pulseiras">Pulseiras</option></select></div>
        <div class="form-group"><label for="nomeProduto">Nome:</label><input type="text" id="nomeProduto" placeholder="Ex: Ter√ßo Tradicional"></div>
        <div class="form-group"><label for="descricao">Descri√ß√£o:</label><textarea id="descricao" placeholder="Descreva o produto..."></textarea></div>
        <div class="form-group"><label for="pedrasAveMaria">Pedras (Ave-Maria):</label><input type="text" id="pedrasAveMaria" placeholder="Opcional"></div>
        <div class="form-group"><label for="pedrasPaiNosso">Pedras (Pai Nosso):</label><input type="text" id="pedrasPaiNosso" placeholder="Opcional"></div>
        <div class="form-group"><label for="detalhesCrucifixo">Crucifixo e entremeio:</label><input type="text" id="detalhesCrucifixo" placeholder="Opcional"></div>
        <div class="form-group"><label for="divisao">Divis√µes:</label><input type="text" id="divisao" placeholder="Opcional"></div>
        <div class="form-group"><label for="preco">Pre√ßo (R$):</label><input type="number" id="preco" step="0.01" placeholder="Ex: 25.00"></div>
    <div class="form-group"><label for="imagensFiles">Escolher imagens (ou cole URLs abaixo):</label><input type="file" id="imagensFiles" multiple accept="image/*"></div>
    <div class="form-group"><label for="formatSelect">Formatar imagens para:</label><select id="formatSelect"><option value="image/jpeg">JPG (boa compatibilidade)</option><option value="image/png">PNG (sem perdas)</option><option value="image/webp">WebP (menor tamanho)</option></select></div>
    <div class="form-group"><label for="imagensURLs">URLs das Imagens:</label><textarea id="imagensURLs" placeholder="Cole os links diretos das imagens aqui, um link por linha..."></textarea><small style="color:#777">Voc√™ pode enviar arquivos locais ou colar links diretos; arquivos ser√£o convertidos e enviados ao servidor.</small></div>
        <button class="btn-admin" id="formButton" onclick="submeterFormulario()">Cadastrar Produto</button><button class="btn-admin" id="cancelarEdicaoBtn" onclick="cancelarEdicao()">Cancelar Edi√ß√£o</button>
        <div class="success-message" id="formSuccess"></div><div class="error-message" id="formError"></div>
    </div><div id="gerenciarProdutos"><h2 class="admin-title">Gerenciar Produtos</h2><ul id="listaProdutosAdmin"></ul></div></div>
</div>
<footer style="margin-top: 100px; padding: 20px; text-align: center; color: #aaa;"><p>Desenvolvido por <strong>Luana Borborema</strong></p><p style="font-size: 0.9rem; margin-top: 10px;">Contato: (44) 99166-2198 | luanaferreiraborborema489@gmail.com</p></footer>
<script>
    const API_URL = (location.hostname === 'localhost' || location.hostname === '127.0.0.1') ? 'http://localhost:3001' : 'https://atelie-backend-luana.onrender.com';
    let pollingInterval = null;
    async function handleFetch(url, options) { try { const response = await fetch(url, options); const data = await response.json(); if (!response.ok) throw new Error(data.error || `Erro de servidor: ${response.status}`); return data; } catch (error) { console.error('Erro na comunica√ß√£o com a API:', error); throw error; } }
    function showMessage(elementId, message) { const el = document.getElementById(elementId); el.textContent = message; el.style.display = 'block'; setTimeout(() => { el.style.display = 'none'; }, 5000); }
    async function verificarSenha() { try { await handleFetch(`${API_URL}/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ senha: document.getElementById('senha').value }) }); document.getElementById('loginForm').style.display = 'none'; document.getElementById('adminPanel').style.display = 'block'; carregarProdutosAdmin(); iniciarPollingDeVisualizacoes(); } catch (error) { showMessage('loginError', error.message); } }
    async function carregarProdutosAdmin() {
        const lista = document.getElementById('listaProdutosAdmin'); lista.innerHTML = '<li>Carregando...</li>';
        try { const produtos = await handleFetch(`${API_URL}/produtos`); lista.innerHTML = ''; if (produtos.length === 0) { lista.innerHTML = '<li>Nenhum produto cadastrado.</li>'; return; } produtos.forEach(p => { const item = document.createElement('li'); item.className = 'produto-item-admin'; item.innerHTML = `<span>${p.nome}</span><div class="actions-container"><span class="views-count" id="view-count-${p._id}">üëÅÔ∏è ${p.visualizacoes || 0}</span><div><button class="btn-action btn-edit" onclick="prepararEdicao('${p._id}')">Editar</button><button class="btn-action btn-delete" onclick="excluirProduto('${p._id}', '${p.nome}')">Excluir</button></div></div>`; lista.appendChild(item); }); } catch (error) { lista.innerHTML = `<li>Erro: ${error.message}</li>`; }
    }
    async function atualizarContagemDeVisualizacoes() {
        try { const produtos = await handleFetch(`${API_URL}/produtos`); produtos.forEach(p => { const viewElement = document.getElementById(`view-count-${p._id}`); if (viewElement) { viewElement.innerText = `üëÅÔ∏è ${p.visualizacoes || 0}`; } }); } catch (error) { console.error("Erro no polling:", error.message); clearInterval(pollingInterval); }
    }
    function iniciarPollingDeVisualizacoes() { if (pollingInterval) { clearInterval(pollingInterval); } pollingInterval = setInterval(atualizarContagemDeVisualizacoes, 5000); }
    async function excluirProduto(id, nome) { if (!confirm(`Tem certeza que deseja excluir "${nome}"?`)) return; try { await handleFetch(`${API_URL}/produtos/${id}`, { method: 'DELETE' }); showMessage('formSuccess', `Produto "${nome}" exclu√≠do!`); carregarProdutosAdmin(); } catch (error) { showMessage('formError', `Erro ao excluir: ${error.message}`); } }
    async function prepararEdicao(id) {
        try {
            const produto = await handleFetch(`${API_URL}/produtos/${id}`);
            document.getElementById('formTitle').innerText = 'Editando Produto';
            document.getElementById('produtoId').value = produto._id;
            ['categoria', 'nomeProduto', 'descricao', 'preco', 'pedrasAveMaria', 'pedrasPaiNosso', 'detalhesCrucifixo', 'divisao'].forEach(key => { document.getElementById(key).value = produto[key.replace('nomeProduto', 'nome')] || ''; });
            const imagensAtuais = (produto.imagens && produto.imagens.length > 0) ? produto.imagens : (produto.imagem ? [produto.imagem] : []);
            document.getElementById('imagensURLs').value = imagensAtuais.join('\n');
            document.getElementById('formButton').innerText = 'Salvar Altera√ß√µes'; document.getElementById('cancelarEdicaoBtn').style.display = 'block'; window.scrollTo({ top: 0, behavior: 'smooth' });
        } catch (error) { showMessage('formError', error.message); }
    }
    function cancelarEdicao() {
        document.getElementById('formTitle').innerText = 'Cadastrar Novo Produto';
        ['produtoId', 'nomeProduto', 'descricao', 'preco', 'pedrasAveMaria', 'pedrasPaiNosso', 'detalhesCrucifixo', 'divisao', 'imagensURLs'].forEach(id => { document.getElementById(id).value = ''; });
        document.getElementById('categoria').value = 'tercos'; document.getElementById('formButton').innerText = 'Cadastrar Produto'; document.getElementById('cancelarEdicaoBtn').style.display = 'none';
    }
    async function submeterFormulario() {
        const produtoId = document.getElementById('produtoId').value;
        const isEditing = !!produtoId;
        try {
            // primeiro: pega URLs j√° coladas
            const urlsTexto = document.getElementById('imagensURLs').value;
            let urlsArray = urlsTexto.split('\n').map(url => url.trim()).filter(url => url);

            // se houver arquivos selecionados, converte no cliente e faz upload
            const fileInput = document.getElementById('imagensFiles');
            if (fileInput && fileInput.files && fileInput.files.length > 0) {
                const files = Array.from(fileInput.files);
                const targetType = document.getElementById('formatSelect').value || 'image/jpeg';
                // converte cada arquivo para Blob no formato escolhido
                const convertedBlobs = await Promise.all(files.map(f => convertImageFileToType(f, targetType)));
                const formData = new FormData();
                convertedBlobs.forEach((b, i) => {
                    const ext = mimeToExt(b.type);
                    formData.append('images', b, `img_${Date.now()}_${i}.${ext}`);
                });
                // tenta enviar ao backend; se receber 404 ou erro de conex√£o, avisa e pede para colar URLs manualmente
                try {
                    const uploadResp = await fetch(`${API_URL}/upload`, { method: 'POST', body: formData });
                    const uploadData = await uploadResp.json().catch(() => null);
                    if (!uploadResp.ok) {
                        if (uploadResp.status === 404) {
                            showMessage('formError', 'Endpoint /upload n√£o encontrado no servidor. Cole URLs manualmente ou verifique o backend.');
                        } else {
                            throw new Error(uploadData && uploadData.error ? uploadData.error : 'Erro no upload das imagens.');
                        }
                    } else {
                        urlsArray = urlsArray.concat(uploadData.urls || []);
                    }
                } catch (err) {
                    showMessage('formError', `Falha ao conectar para upload: ${err.message}. Cole URLs manualmente.`);
                }
            }

            if (urlsArray.length === 0) { throw new Error('Pelo menos uma imagem (arquivo ou URL) √© obrigat√≥ria.'); }

            const produtoData = {
                categoria: document.getElementById('categoria').value,
                nome: document.getElementById('nomeProduto').value,
                descricao: document.getElementById('descricao').value,
                preco: parseFloat(document.getElementById('preco').value),
                imagens: urlsArray,
                pedrasAveMaria: document.getElementById('pedrasAveMaria').value,
                pedrasPaiNosso: document.getElementById('pedrasPaiNosso').value,
                detalhesCrucifixo: document.getElementById('detalhesCrucifixo').value,
                divisao: document.getElementById('divisao').value
            };

            if (isEditing) {
                produtoData.imagem = undefined;
            }

            const url = isEditing ? `${API_URL}/produtos/${produtoId}` : `${API_URL}/produtos`;
            const method = isEditing ? 'PUT' : 'POST';

            await handleFetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(produtoData) });
            showMessage('formSuccess', `Produto ${isEditing ? 'atualizado' : 'cadastrado'}!`);
            cancelarEdicao(); carregarProdutosAdmin();
        } catch (error) { showMessage('formError', `Erro: ${error.message}`); }
    }

    // converte um File (imagem) para Blob no tipo targetType via canvas
    function convertImageFileToType(file, targetType = 'image/jpeg', quality = 0.9) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.naturalWidth;
                canvas.height = img.naturalHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                canvas.toBlob(blob => {
                    if (blob) resolve(blob);
                    else reject(new Error('Falha ao converter imagem.'));
                }, targetType, quality);
            };
            img.onerror = (e) => reject(new Error('Falha ao carregar imagem local.'));
            const reader = new FileReader();
            reader.onload = () => { img.src = reader.result; };
            reader.onerror = () => reject(new Error('Erro ao ler o arquivo local.'));
            reader.readAsDataURL(file);
        });
    }

    function mimeToExt(mime) {
        if (!mime) return 'jpg';
        if (mime.includes('jpeg')) return 'jpg';
        if (mime.includes('png')) return 'png';
        if (mime.includes('webp')) return 'webp';
        return 'jpg';
    }
</script>
</body>
</html>